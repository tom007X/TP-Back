services:
  gateway-service:
    build:
      context: ./gateway
      dockerfile: Dockerfile
    container_name: gateway-container
    ports:
      - "8093:8093" # puerto interno del gateway → puerto local
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - JAVA_OPTS=-Xms256m -Xmx512m
    networks:
      - backend-net

  keycloak:
    image: quay.io/keycloak/keycloak:24.0.3
    container_name: keycloak
    command: start-dev
    ports:
      - "8081:8080"
    environment:
      - KEYCLOAK_ADMIN=admin
      - KEYCLOAK_ADMIN_PASSWORD=admin123
    volumes:
      - keycloak_data:/opt/keycloak/data
    networks:
      - backend-net

  shipping-microservice:
    build: ./ShippingMicroservice
    container_name: shipping_microservice_container
    depends_on:
      shipping-request-db:
        condition: service_healthy
    environment:
      DB_HOST: shipping-request-db
      DB_PORT: 3306
      DB_NAME: mi_basedatos_app
      DB_USER: user_1
      DB_PASSWORD: mi_usUario22
      GOOGLE_API_KEY: AIzaSyAzX1ma-i25KjrXbIA9TTdoxWRbE975a3I
    ports:
      - "8090:8090"
    restart: on-failure
    networks:
      - backend-net # Conectado a la red única

  truck-microservice: # Estaba mal indentado, ahora está al mismo nivel que los demás servicios
    build: ./TruckMicroservice
    container_name: truck_Microservice
    depends_on:
      mysql:
        condition: service_healthy
    environment:
      DB_HOST: mysql
      DB_PORT: 3306
      DB_NAME: mi_basedatos_app
      DB_USER: user_1
      DB_PASSWORD: mi_usUario22
    ports:
      - "8091:8091"
    restart: always
    networks:
      - backend-net # Conectado a la red única

  client-microservice:
    build: ./client-api
    container_name: client_Microservice
    depends_on:
      client-db:
        condition: service_healthy
    environment:
      DB_HOST: client-db
      DB_PORT: 3306
      DB_NAME: mi_basedatos_app
      DB_USER: user_1
      DB_PASSWORD: mi_usUario22
    ports:
      - "8092:8092"
    restart: always
    networks:
      - backend-net

  mysql: # Base de datos para truck-microservice (renombrada de 'mysql' a 'truck-db' para claridad, aunque se mantiene 'mysql' para respetar 'DB_HOST')
    image: mysql:8.0.33
    container_name: truck_mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: root_1
      MYSQL_DATABASE: mi_basedatos_app
      MYSQL_USER: user_1
      MYSQL_PASSWORD: mi_usUario22
    healthcheck:
      test: [ "CMD", "mysqladmin" ,"ping", "-h", "localhost" ]
      interval: 5s
      timeout: 5s
      retries: 10
    ports:
      - "3310:3306"
    volumes:
      - mysql_data_truck:/var/lib/mysql
    networks:
      - backend-net
    # command: --default-authentication-plugin=mysql_native_password

  client-db: # Estaba mal indentado, ahora está al mismo nivel que los demás servicios
    image: mysql:8.0.33
    container_name: client_mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: root_1
      MYSQL_DATABASE: mi_basedatos_app
      MYSQL_USER: user_1
      MYSQL_PASSWORD: mi_usUario22
    healthcheck:
      test: [ "CMD", "mysqladmin" ,"ping", "-h", "localhost" ]
      interval: 5s
      timeout: 5s
      retries: 10
    ports:
      - "3320:3306"
    volumes:
      - mysql_data_client:/var/lib/mysql
    networks:
      - backend-net # Conectado a la red única

  shipping-request-db: # Estaba mal indentado, ahora está al mismo nivel que los demás servicios
    image: mysql:8.0.33
    container_name: shipping_request_mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: root_1
      MYSQL_DATABASE: mi_basedatos_app
      MYSQL_USER: user_1
      MYSQL_PASSWORD: mi_usUario22
    healthcheck:
      test: [ "CMD", "mysqladmin" ,"ping", "-h", "localhost" ]
      interval: 5s
      timeout: 5s
      retries: 10
    ports:
      - "3315:3306"
    volumes:
      - mysql_data_shipping_request:/var/lib/mysql
    networks:
      - backend-net # Conectado a la red única
    # command: --default-authentication-plugin=mysql_native_password

volumes: # Bloque de volúmenes al nivel raíz (donde debe estar)
  mysql_data_client:
  keycloak_data:
  mysql_data_truck:
  mysql_data_shipping_request:

networks: # Bloque de redes al nivel raíz (donde debe estar)
  backend-net:
    driver: bridge